---
config:
  layout: elk
  theme: neutral
---
flowchart TB
  subgraph LEGEND["Legend"]
        direction TB
        L_UX1["Phase 1"]:::phase1_ux
        L_UX2["Phase 2"]:::phase2_ux
        L_SYS["Phase 1 - System / Backend Logic"]:::phase1_dim
  end

  subgraph WAREHOUSE["Returns Delivery & Processing"]
        direction TB
        subgraph WH_CA["Caledonia (Canada)"]
            R1["WF-090 | Return delivered to Caledonia"]
            R2["WF-091 | Caledonia team updates return status in portal (limited access role)"]
            R4["WF-092 | Update status: Delivered → Processing / Inspection Completed"]
            R5@{ label: "WF-093 | Store Ops run 'Returned items' report for inventory update" }
        end

        subgraph WH_US["US Warehouse (LA / NJ)"]
            R_US["WF-133 | Return delivered to US Warehouse (LA/NJ)"]
            R2_US["WF-134 | US Warehouse team emails return status to Internal Ops (offline to Claimlane)"]
            R4_US["WF-135 | Internal Ops Update status: Delivered → Processing / Inspection Completed"]
            R5_US["WF-136 | Internal Ops run 'Returned items' report"]
            R5_US@{ shape: rect}
        end
  end

    %% ---------------------------------------------------------
    %% ENTRY POINT – PURCHASE CHANNEL SELECTION
    %% WF-002, WF-003, WF-004 are parallel workstreams
    %% ---------------------------------------------------------
    A["WF-001 | Where did you purchase?"] --> OnlineCA["WF-002 | Silk & Snow Online – CA (WooCommerce)"] & OnlineUS["WF-094 | Silk & Snow Online – US (WooCommerce)"] & Retail["WF-003 | Silk & Snow Retail Store (in-person)"] & D["WF-004 | Third-party vendor: TSC, EQ3, Costco"]

    %% Online workstream
    OnlineCA --> B0["WF-023 | What do you need help with?"]

    %% US Online workstream
    OnlineUS --> US_B0["WF-096 | What do you need help with?"]
    US_B0 --> SHARED_BR & SHARED_BW


    %% SHARED LOGIN & VALIDATION (Return + Warranty)
    SHARED_BR & SHARED_BW --> SHARED_LOGIN["WF-026/099/042 | Enter order number and email"]
    SHARED_LOGIN --> SHARED_VALIDATE{"WF-027/100/043 | Order validated?"}
    
    SHARED_VALIDATE -- No --> SHARED_LOGIN_ERR["WF-028/101/044 | Show error & allow retry or contact support <br> Display error message: 'For orders purchased in store, an email may not have been provided.'</br><br> 'Allow retry with Order Number and Phone Number.'</br>"]
    SHARED_VALIDATE -- Yes --> FLOW_ROUTER{"Flow Type?"}
    
    FLOW_ROUTER -- Return --> SHARED_OR3["WF-029/102 | Display all items in order"]

    
    SHARED_OR3 --> SHARED_OR4["WF-030/103 | Select items to return"]

    
    %% Bypass Promo Checks (Removed per plan)
    SHARED_OR4 --> REASON_CHECK{"Return Reason = Defective? && Client did not opt out of a product replacement."}
    
    REASON_CHECK -- Yes --> OW3
    REASON_CHECK -- No --> SHARED_OR5{"WF-038/105 | Item type selected"}
    
    %% Shared Output Logic
    SHARED_OR5 -- Mattress --> M2{"WF-039 | Is mattress boxed?"}
    SHARED_OR5 -- Furniture --> F1["WF-040 | Furniture return"]
    SHARED_OR5 -- Accessory/Bedding --> REGION_CHECK{"Region?"}
    
    REGION_CHECK -- US --> US_OpenCheck{"WF-115 | Is item opened?"}
    REGION_CHECK -- CA --> A1["WF-041 | Accessory / Bedding return"]
    
    %% Shared US Endpoints (referenced by Accessory flow)
    US_Decline["WF-109 | Return Declined / Negotiated Offline"] --> FinalProcess
    US_Logistics["WF-111 | Generate Label / Schedule Pickup"] --> Received

    %% US Accessories & Bedding New Logic (Abuse Check -> Options)

    
    US_OpenCheck -- Unopened --> US_ShipCalc{"WF-116 | Shipping Cost > 1/3 Item Value?"}
    US_ShipCalc -- Low Cost --> US_Logistics
    US_ShipCalc -- High Cost --> US_Offer1

    US_OpenCheck -- Opened --> US_Offer1{"WF-117 | Option 1: Keep for 50% Refund<br>(No proof required)"}
    
    US_Offer1 -- Accepted --> US_Ref50["WF-118 | Process 50% Refund"]
    US_Ref50 --> FinalProcess
    
    US_Offer1 -- Rejected --> US_Offer2{"WF-119 | Option 2: Donate for 100% Refund<br>(Proof required)"}
    
    US_Offer2 -- Accepted --> US_DonateStep["WF-120 | Client agrees to 100% Option, donates item, takes picture, and contacts CX (Call/Email)"]
    US_DonateStep --> US_CXProcess["WF-121 | CX team processes return in ClaimLane portal"]
    US_CXProcess --> FinalProcess
    US_Offer2 -- Rejected --> US_Decline


    %% Retail workstream
    Retail --> RS1["WF-018 | Select the store you purchased from"]

    %% Third-party vendor workstream
    D --> TP0["WF-005 | Select third-party vendor (TSC, EQ3, Costco)"]
    TP0 --> TP1["WF-006 | Collect required evidence (receipt, photos, law tags, other)"]
    TP1 --> TP2["WF-007 | Log action item in ClaimLane: Third-party vendor review required"]
    TP2 --> TP3["WF-008 | Send email notification to vendor (ticket created)"]
    TP3 --> TP4{"WF-009 | Vendor approves to proceed?"}
    TP4 -- No --> TP5["WF-010 | Vendor declines: Communicate decision + next steps to customer"]
    TP5 --> FinalProcess["WF-060 | Close case / completion"]
    TP4 -- Yes --> TP6{"WF-011 | Does customer need pickup assistance or defective item removal request?"}
    TP6 -- Yes --> TP_Split{"WF-011A | Pickup type?"}
    TP6 -- No --> TP8["WF-013 | Customer proceeds with vendor instructions (no CX pickup coordination)"]

    TP_Split -- Courier --> TP7["WF-012 | CX provides pickup assistance (coordination + guidance) <br/> Generate Return Label"]
    TP_Split -- Disposal --> TP_Logistics["WF-011B | Log for Return Logistics"]
    
    TP_Logistics --> RL1
    TP7 --> TP9["WF-014 | Pickup confirmed / scheduled"]
    TP8 --> TP9
    TP9 --> TP10["WF-015 | Item received (confirm receipt)"]
    TP10 --> R1 & TP11["WF-016 | Email vendor: Proceed with return / refund"]
    TP11 --> FinalProcess
    TP1 -.-> TP_NOTE["WF-017 | Note: Exact evidence requirements to be confirmed per vendor (TSC/EQ3)."]

    RS1 --> RS2{"WF-019 | Store backend (system lookup)"}
    RS2 -- Shopify POS store --> B0
    RS2 -- "STORIS (non-Shopify) store" --> RS3["WF-021 | Message: This return cannot be processed through this portal. Please call the Sleep Country Customer Service team for further instructions."]
    RS3 --> RSEnd["WF-022 | End – customer must visit store to complete return"]

    B0 --> SHARED_BR["WF-024/097 | Return"] & SHARED_BW["WF-025/098 | Warranty claim"]

    
    %% SHARED_BW flows into SHARED_LOGIN (see above)


    %% ---------------------------------------------------------
    %% RETURN FLOW (Now merged above with US)
    %% ---------------------------------------------------------
    %% Handled by SHARED_OR nodes defined in US section blocks
    
    %% Old connections removed (OR1..OR5) merged into SHARED_* path
    %% Mattress/Furniture/Accessory routing handled at SHARED_OR5

    %% ---------------------------------------------------------
    %% WARRANTY FLOW (WF-052 MOVED TO PHASE 1)
    %% Added: CX review + approval, and CX can adjust selected part
    %% ---------------------------------------------------------

    %% SHARED_BW flows here (Merged into SHARED_LOGIN above)
    %% OW1/OW2 removed


    FLOW_ROUTER -- Warranty --> OW3["WF-052 | Display all items in the order (include replacement parts & product guide based on products selected)"]
    OW3 -.-> WRP_NOTE@{ label: "WF-052A | Note: Replacement parts should be shown with product context<br><br><p data-start=\"186\" data-end=\"272\"><strong data-start=\"186\" data-end=\"239\">Example – Nara Wooden Dresser (5-Drawer, Cortado)</strong><br data-start=\"239\" data-end=\"242\"><br>Parent SKU: <strong data-start=\"254\" data-end=\"270\">SNSFNDR5005T</strong></p><ul data-start=\"273\" data-end=\"488\"><li data-start=\"273\" data-end=\"313\"><p data-start=\"275\" data-end=\"313\">Drawer – Top Left | SNSFNDR5005TDRSL</p></li><li data-start=\"314\" data-end=\"355\"><p data-start=\"316\" data-end=\"355\">Drawer – Top Right | SNSFNDR5005TDRSR</p></li><li data-start=\"356\" data-end=\"392\"><p data-start=\"358\" data-end=\"392\">Drawer – Large | SNSFNDR5005TDRB</p></li><li data-start=\"393\" data-end=\"418\"><p data-start=\"395\" data-end=\"418\">Screw | SNSFNS5000TSW</p></li><li data-start=\"419\" data-end=\"454\"><p data-start=\"421\" data-end=\"454\">Stain &amp; Brush | SNSFNWO5000ACST</p></li><li data-start=\"455\" data-end=\"488\"><p data-start=\"457\" data-end=\"488\">Stain &amp; Brush | SNSFNS5000TST</p></li></ul>" }

    OW3 --> OW4["WF-053 | Customer selects an item or replacement part (sub-part)"]
    OW4 --> WInfo["WF-054 | Collect additional info: issue description, photos, pickup assistance needed, address confirmation"]
    WInfo --> WCL["WF-055 | Submit warranty case to ClaimLane (selected part SKUs + evidence + notes)"]

    %% New Phase 1 steps (WF-052 workstream additions)
    WCL --> WCXReview["WF-052B | CX reviews photos + validates selection"]
    WCXReview --> WCXApprove{"WF-052C | CX approves to proceed?"}
    WCXApprove -- No --> WDecline["WF-052D | Communicate decline / next steps"]
    WDecline --> FinalProcess
    WCXApprove -- Yes --> WPickupCheck{"WF-052F | Pickup assistance needed?"}
    
    WPickupCheck -- Yes --> WPickupType{"WF-052H | Pickup type?"}
    WPickupCheck -- No --> WCX

    WPickupType -- Courier --> WPickupAction["WF-052G | CX provides pickup assistance (coordination + guidance)<br/>Generate Return Label (need the word Defective in the label - this will help warehouse to avoid inspection of that piece)"]
    WPickupType -- Disposal --> WLogistics["WF-052I | Log case for Return Logistics Team"]
    
    WPickupAction --> WCX
    WLogistics --> RL1

    WCX["WF-056 | CX places replacement order in WooCommerce (based on approved replacement part SKUs)"]

    WCX --> WClose["WF-058 | Close case after replacement order is placed"]
    WClose --> FinalProcess

    %% ---------------------------------------------------------
    %% SHARED RETURN LOGISTICS (Combines WF-059 & WF-065A)
    %% ---------------------------------------------------------
    RL1{"WF-059/065A | Return Logistics: Select donation / pickup vendor"}
    RL1 -- Vendor Selected --> RL2["WF-061/066 | Trigger emails: vendor + customer"]
    RL1 -- No Vendor Available --> M_SelfDonate
    RL2 --> RL3{"WF-062/067A | Change vendor?"}
    RL3 -- Yes --> RL4["WF-063/068A | Select new vendor → trigger updated emails"]
    RL3 -- No --> RL5
    RL4 --> RL5["WF-064/063A | Vendor picks up item and marks Picked"]
    RL5 --> Received["WF-089 | Item marked Received in portal"]

    %% ---------------------------------------------------------
    %% MATTRESS / FURNITURE / ACCESSORY RETURN SUBFLOWS
    %% ---------------------------------------------------------
    M2 -- Yes --> MInfo["WF-061A | Collect extra info: photos"]
    MInfo --> MInstr["WF-062A | Provide return label / pickup details"]
    MInstr --> RL5

    M2 -- No --> MUInfo["WF-064A | Collect extra info: photos, law tag, condition"]
    MUInfo --> RL1
    
    M_SelfDonate["WF-130 | Client donates item, takes picture, and contacts CX"] --> M_CXProcess["WF-132 | CX team processes return in ClaimLane portal"]
    M_CXProcess --> FinalProcess

    F1 --> FInfoPhotos["WF-069A | Customer uploads photos + issue details"]
    
    FInfoPhotos --> F_RegionCheck{"Region?"}

    F_RegionCheck -- CA --> F_WooCommerce_CA["WF-137 | ClaimLane calls WooCommerce API for carrier quotes (CA) - Destination is always Caledonia location"]
    F_WooCommerce_CA --> FInfoDetails["WF-073A | Notify charges and Collect pickup details"]

    F_RegionCheck -- US --> F_US_Calc["WF-138 | ClaimLane calls WooCommerce API for carrier quotes (US) - Destination is Order Origin location (LA or NJ location)"]
    F_US_Calc --> FInfoDetails

    FInfoDetails --> FCXReview["WF-070A | CX reviews"]
    FCXReview --> FCXApprove{"WF-071A | CX approves?"}
    
    FCXApprove -- No --> FCXDecline["WF-072A | Communicate decline"]
    FCXDecline --> FinalProcess
    
    FCXApprove -- Yes --> FLabelPickup["WF-074A | Generate label + instructions"]
    FLabelPickup --> F3["WF-075A | Arrange pickup"]
    F3 --> Received

    A1 --> AInfo["WF-076A | Collect info"]
    AInfo --> AInstr["WF-077A | Provide mail-in instructions & Generate Return Label"]
    AInstr --> A2["WF-078A | Customer ships item"]
    A2 --> Received

    %% ---------------------------------------------------------
    %% RECEIVED → REFUND LOGIC
    %% Phase 2 items under WF-072 remain
    %% ---------------------------------------------------------
    Received --> RecRouter{"Flow Context?"}
    RecRouter -- Return --> PH1Q{"WF-066B | Is this Phase 1?"}
    RecRouter -- Warranty --> WCX
    RecRouter -- 3rdParty --> TP11["WF-016 | Email vendor: Proceed with return / refund"]
    RecRouter -- 3rdParty --> R1

    PH1Q -- Yes --> RV1{"WF-067 | Return order value < 600 AND order does not contain bundles or free items?"} & Dest_Check{"Destination?"}
    
    Dest_Check -- CA --> R1
    Dest_Check -- US --> R_US

    RV1 -- Yes --> AutoRefund["WF-068 | Auto refund"]
    RV1 -- No --> ManualRefund["WF-069 | Manual refund"]
    AutoRefund --> FinalProcess
    ManualRefund --> FinalProcess

    PH1Q -- No --> P2BND["WF-070 | Future Phase: Calculate bundle impacts and adjusted refundable amounts"]
    P2BND --> P2RF{"WF-071 | Auto refund eligible after bundle calculation?"}
    P2RF -- Yes --> P2AutoRefund["WF-072 | Auto refund if order value < 600 (post-bundle calc)"]
    P2RF -- No --> P2ManualRefund["WF-073 | Manual refund (post-bundle calc)"]
    P2AutoRefund --> FinalProcess
    P2ManualRefund --> FinalProcess

    RV1 -.-> CL_BND_NOTE["WF-074 | Note: We cannot implement auto-refunds when bundles or free items are involved until we fix WooCommerce, which is currently restricting Claimlane's data"]
    P2BND -.-> CL_BND_NOTE

    %% Caledonia routing
    R1 --> R2
    R2 --> R4
    R4 --> R5
    R5 --> FinalProcess

    %% US Warehouse routing
    R_US --> R2_US
    R2_US --> R4_US
    R4_US --> R5_US
    R5_US --> FinalProcess

    %% Shapes
    R5@{ shape: rect}
    WRP_NOTE@{ shape: rect}

      %% ---------------------------------------------------------
      %% PHASE TAGGING (UPDATED for UX Focus)
      %% ---------------------------------------------------------

      %% Backend / Internal / Logistics (Dimmed)
      OnlineUS:::phase1_dim
      OnlineCA:::phase1_dim
      
      R1:::phase1_dim
      R2:::phase1_dim
      R4:::phase1_dim
      R5:::phase1_dim
      Retail:::phase1_dim
      D:::phase1_dim
      TP2:::phase1_dim
      TP3:::phase1_dim
      TP4:::phase1_dim
      TP6:::phase1_dim
      TP8:::phase1_dim
      TP9:::phase1_dim
      TP10:::phase1_dim
      TP11:::phase1_dim
      RS2:::phase1_dim
      SHARED_BR:::phase1_dim
      SHARED_BW:::phase1_dim
      SHARED_LOGIN:::phase1_ux
      SHARED_VALIDATE:::phase1_dim
      FLOW_ROUTER:::phase1_dim
      REASON_CHECK:::phase1_dim
      SHARED_OR5:::phase1_dim
      REGION_CHECK:::phase1_dim
      M2:::phase1_dim
      F1:::phase1_dim
      A1:::phase1_dim

      WCL:::phase1_dim
      WCXReview:::phase1_dim
      WCXApprove:::phase1_dim
      WPickupCheck:::phase1_dim
      WPickupType:::phase1_dim
      WLogistics:::phase1_dim

      WCX:::phase1_dim
      WClose:::phase1_dim
      TP_Split:::phase1_dim
      TP_Logistics:::phase1_dim
      RL1:::phase1_dim
      RL3:::phase1_dim
      RL5:::phase1_dim
      Received:::phase1_dim
      RecRouter:::phase1_dim
      FCXReview:::phase1_dim
      FCXApprove:::phase1_dim
      F3:::phase1_dim
      A2:::phase1_dim
      PH1Q:::phase1_dim
      RV1:::phase1_dim
      AutoRefund:::phase1_dim
      ManualRefund:::phase1_dim
      
      %% Phase 2 Backend (Dimmed)
      P2BND:::phase2_dim
      P2RF:::phase2_dim
      P2AutoRefund:::phase2_dim
      P2ManualRefund:::phase2_dim

      %% Client Touchpoints (Screens & Customer Emails) - Highlighted
      A:::phase1_ux
      TP0:::phase1_ux
      TP1:::phase1_ux
      TP5:::phase1_ux
      TP7:::phase1_ux
      RS1:::phase1_ux
      RS3:::phase1_ux
      B0:::phase1_ux

      SHARED_LOGIN_ERR:::phase1_ux
      SHARED_OR3:::phase1_ux
      SHARED_OR4:::phase1_ux

      OW3:::phase1_ux
      OW4:::phase1_ux
      WInfo:::phase1_ux
      WPickupAction:::phase1_ux
      WDecline:::phase1_ux
      RL2:::phase1_ux
      RL4:::phase1_ux
      MInfo:::phase1_ux
      MInstr:::phase1_ux
      MUInfo:::phase1_ux
      FInfoPhotos:::phase1_ux
      FCXDecline:::phase1_ux
      FInfoDetails:::phase1_ux
      FLabelPickup:::phase1_ux
      AInfo:::phase1_ux
      AInstr:::phase1_ux

      %% US UX/Touchpoints (New)
      US_B0:::phase1_ux



      US_Decline:::phase1_ux


      US_OpenCheck:::phase1_ux
      US_Offer1:::phase1_ux
      US_Offer2:::phase1_ux
      US_DonateStep:::phase1_ux
      
      %% US System/Backend (New)
      %%US_B:::phase1_dim



      US_Logistics:::phase1_dim

      US_ShipCalc:::phase1_dim
      US_CXProcess:::phase1_dim
      US_Ref50:::phase1_dim

      %% Detailed US/CA Warehouse items
      R_US:::phase1_dim
      R2_US:::phase1_dim
      R4_US:::phase1_dim
      R5_US:::phase1_dim
      
      F_RegionCheck:::phase1_dim
      F_WooCommerce_CA:::phase1_dim
      F_US_Calc:::phase1_dim
      Dest_Check:::phase1_dim

      %% Unboxed Mattress Self-Donate
      M_SelfDonate:::phase1_ux
      M_CXProcess:::phase1_dim
      
      %% UX END POINTS (Choice A)
      RSEnd:::phase1_ux
      FinalProcess:::phase2_ux

      %% Notes
      TP_NOTE:::note
      %%BND_NOTE:::note
      WRP_NOTE:::note

      CL_BND_NOTE:::note

    %% ---------------------------------------------------------
    %% CLASS DEFINITIONS
    %% ---------------------------------------------------------
    
    %% UX HIGHLIGHTS: Solid, Bold Colors (UX Team Focus)
    classDef phase1_ux fill:#FFEB3B,stroke:#111,stroke-width:2px,color:#111
    classDef phase2_ux fill:#FF9800,stroke:#111,stroke-width:2px,color:#111

    %% DIMMED WORKFLOWS: Desaturated, Dashed, Lighter (Irrelevant to UX)
    classDef phase1_dim fill:#FFFDE7,stroke:#FBC02D,stroke-width:1px,stroke-dasharray: 5 5,color:#888
    classDef phase2_dim fill:#FFF3E0,stroke:#FFB74D,stroke-width:1px,stroke-dasharray: 5 5,color:#888
    
    %% Other
    classDef tbd fill:#E0E0E0,stroke:#757575,stroke-width:2px,color:#111
    classDef note fill:#E3F2FD,stroke:#64B5F6,stroke-width:2px,color:#0D47A1
    classDef removal_flag fill:#FFEBEE,stroke:#D32F2F,stroke-width:3px,color:#C62828,stroke-dasharray: 5 5

    style WAREHOUSE fill:#FFFDE7,stroke:#B38F00,stroke-width:2px
    style WH_CA fill:#FFFDE7,stroke:#B38F00,stroke-width:1px
    style WH_US fill:#FFFDE7,stroke:#B38F00,stroke-width:1px
